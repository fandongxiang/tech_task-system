<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>参数管理提交页</title>
  <script src="../../assets/lib/JQuery.js"></script>
  <script src="../../assets/js/baseAPI.js"></script>
  <script src="../../assets/lib/echarts.min.js"></script>
  <script src="../../assets/lib/template-web.js"></script>
  <link rel="stylesheet" href="../../assets/css/tech_arguments_submit.css">
</head>

<body>
  <!-- 版面div -->
  <div id="page">
    <!-- 头部 -->
    <header class="clearfix">
      <!-- 预览区头部 -->
      <div id="header-left">
        <p>对比预览区</p>
      </div>
      <!-- 提交区头部 -->
      <div id="header-right">
        <div id="submit">
          <form action="">
            <!-- 片区选择 -->
            <span>片区选择</span>
            <select name="zoom" id="select_zoom">
                <option selected>A1</option>
                <option>A2</option>
                <option>B1</option>
                <option>B2</option>
                <option>C1</option>
                <option>C2</option>
                <option>D1</option>
                <option>D2</option>
                <option>E1</option>
                <option>E2</option>
            </select>
            <!-- 合同选择 -->
            <span>合同选择</span>
            <select name="contract" id="select_contract" class="b-select contractChange">
              <option>890A0</option>
              <option>890C0</option>
              <option>PB237</option>
              <option>新建合同</option>
            </select>
            <!-- 参数类型 -->
            <span>参数类型</span>
            <select name="type" id="select_type" class="b-select">
              <option>等径</option>
              <option>放肩</option>
            </select>
            <!-- 提交说明 -->
            <span>提交说明</span>
            <input type="text" name="" id="select_discription">
            <!-- 提交 -->
            <button id="sub_submit">提交</button>
          </form>
        </div>
      </div>
    </header>
    <!-- 预览&提交区 -->
    <div class="clearfix">
      <!-- 对比预览区 -->
      <div id="preview">
        <table id="argu" border="1">
          <thead>
            <tr>
              <td colspan="10">
                <h2>等径斜率表</h2>
              </td>
            </tr>
            <tr>
              <th>序号</th>
              <th>长度mm</th>
              <th>晶转</th>
              <th>埚转</th>
              <th>功率</th>
              <th>拉速</th>
              <th>液口距</th>
              <th>氩气流量</th>
              <th>控制周期</th>
              <th>控制系数</th>
            </tr>
          </thead>
          <tbody id="preview_tbody">

          </tbody>
        </table>
      </div>
      <!-- 提交预览区 -->
      <div id="pre-submit">
        <table id="argu" border="1">
          <thead>
            <tr>
              <td colspan="10">
                <h2>等径斜率表</h2>
              </td>
            </tr>
            <tr>
              <th>序号</th>
              <th>长度mm</th>
              <th>晶转</th>
              <th>埚转</th>
              <th>功率</th>
              <th>拉速</th>
              <th>液口距</th>
              <th>氩气流量</th>
              <th>控制周期</th>
              <th>控制系数</th>
            </tr>
          </thead>
          <tbody id="sub_tbody">

          </tbody>
        </table>
      </div>

    </div>

    <!-- 历史提交区 -->
    <div id="sub-history">
      <table id="sub_history" border="1">
        <thead>
          <tr>
            <th>序号</th>
            <th>片区</th>
            <th>合同</th>
            <th>提交说明</th>
            <th>提交人</th>
            <th>提交时间</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="submitHistory_tbody">

        </tbody>
      </table>
    </div>
  </div>

  <!-- 对比预览区模板 -->
  <script type="text/html" id="getPreview">
    {{each data}}
    <tr>
      <td>{{$value.newId}}</td>
      <td class="compare_length" data-newId="{{$value.newId}}">{{$value.length}}</td>
      <td class="compare_seedRotation" data-newId="{{$value.newId}}">{{$value.seedRotation}}</td>
      <td class="compare_cruRotation" data-newId="{{$value.newId}}">{{$value.cruRotation}}</td>
      <td class="compare_mainHeater" data-newId="{{$value.newId}}">{{$value.mainHeater}}</td>
      <td class="compare_slSpeed" data-newId="{{$value.newId}}">{{$value.slSpeed}}</td>
      <td class="compare_meltLevel" data-newId="{{$value.newId}}">{{$value.meltLevel}}</td>
      <td class="compare_argonFlow" data-newId="{{$value.newId}}">{{$value.argonFlow}}</td>
      <td class="compare_controlTime" data-newId="{{$value.newId}}">{{$value.controlTime}}</td>
      <td class="compare_controlRate" data-newId="{{$value.newId}}">{{$value.controlRate}}</td>
    </tr>
    {{/each}}
  </script>

  <!-- 提交预览区模板 -->
  <script type="text/html" id="getSubmitPreview">
    {{each data}}
    <tr>
      <td>{{$value.newId}}</td>
      <td class="length" contenteditable="true" data-newId="{{$value.newId}}">{{$value.length}}</td>
      <td class="seedRotation" contenteditable="true" data-newId="{{$value.newId}}">{{$value.seedRotation}}</td>
      <td class="cruRotation" contenteditable="true" data-newId="{{$value.newId}}">{{$value.cruRotation}}</td>
      <td class="mainHeater" contenteditable="true" data-newId="{{$value.newId}}">{{$value.mainHeater}}</td>
      <td class="slSpeed" contenteditable="true" data-newId="{{$value.newId}}">{{$value.slSpeed}}</td>
      <td class="meltLevel" contenteditable="true" data-newId="{{$value.newId}}">{{$value.meltLevel}}</td>
      <td class="argonFlow" contenteditable="true" data-newId="{{$value.newId}}">{{$value.argonFlow}}</td>
      <td class="controlTime" contenteditable="true" data-newId="{{$value.newId}}">{{$value.controlTime}}</td>
      <td class="controlRate" contenteditable="true" data-newId="{{$value.newId}}">{{$value.controlRate}}</td>
    </tr>
    {{/each}}
  </script>

  <!-- 合同选择模板 -->
  <script type="text/html" id="getContract">
    {{if data.length == 0}}
    <option>请新建</option>
    <option>新建合同</option>
    {{else}} {{each data}}
    <option>{{$value.contract}}</option>
    {{/each}}
    <option>新建合同</option>
    {{/if}}
  </script>

  <!-- 历史提交区模板 -->
  <script type="text/html" id="getHistorySubmit">
    {{each data}}
    <tr>
      <td>{{$value.newId}}</td>
      <td>{{$value.zoom}}</td>
      <td>{{$value.contract}}</td>
      <td>{{$value.discription}}</td>
      <td>{{$value.submitter}}</td>
      <td>{{$value.subDay}}</td>
      <td><a href="javascript:;">删除</a></td>
    </tr>
    {{/each}}
  </script>
  <script>
    $(function() {
      // 新建合同
      $('.contractChange').on('change', function() {
        console.log($(this).val());
        if ($(this).val() == '新建合同') {
          // window.location.href = '../tech/tech_arguments.html'
          const newContract = prompt('请输入要添加的合同')
          const newOption = document.createElement('option');
          newOption.innerHTML = newContract;
          $(this).prepend(newOption)
          $(this).val(newContract)
        }
      })

      // 预览区渲染 函数
      function getPreview() {
        // 首次预渲染
        let submitMessage = { // 这个为后续函数公用对象
          zoom: $('select[name="zoom"]').val(),
          contract: $('select[name="contract"]').val(),
          type: $('select[name="type"]').val()
        }
        let zoomMessage = { // 这个函数为后续函数公用对象
          zoom: $('select[name="zoom"]').val()
        }
        getContractAjax(zoomMessage);
        getSubmitAjax(submitMessage);
        getHistorySubmit(zoomMessage);

        // 片区、合同、参数类型选择后渲染
        $('select[name="zoom"]').on('change', function() {
          // 合同渲染 + 参数渲染
          // 注意：这里 参数渲染 必须写在 合同渲染ajax成功函数里，不然得不到参数
          zoomMessage = {
              zoom: $(this).val()
            }
            // 调用合同渲染函数
          getContractAjax(zoomMessage);
          // 调用历史提交区渲染函数
          getHistorySubmit(zoomMessage);
        })
        $('select[name="contract"]').on('change', function() {
          submitMessage.contract = $(this).val()
          getSubmitAjax(submitMessage)
        })
        $('select[name="type"]').on('change', function() {
          submitMessage.type = $(this).val()
          getSubmitAjax(submitMessage)
        })
      }
      getPreview()

      // 合同渲染 ajax请求函数
      function getContractAjax(zoomMessage) {
        $.ajax({
          type: 'POST',
          url: '/tech/arguments/getContract',
          headers: {
            Authorization: localStorage.getItem('token') || ''
          },
          data: zoomMessage,
          success: (res) => {
            let {
              status,
              message,
              data
            } = res;
            if (status != 0) return alert('合同获取失败！');
            const dataStr = template('getContract', {
              data: data
            });
            $('#select_contract').html(dataStr)

            // 调用 getSubmitAjax()
            let submitMessage = {
              zoom: $('select[name="zoom"]').val(),
              contract: $('select[name="contract"]').val(),
              type: $('select[name="type"]').val()
            }
            getSubmitAjax(submitMessage)
          }
        })
      }

      // 参数渲染 ajax请求函数
      function getSubmitAjax(submitMessage) {
        $.ajax({
          type: 'POST',
          url: '/tech/arguments/getPreview',
          headers: {
            Authorization: localStorage.getItem('token') || ''
          },
          data: submitMessage,
          success: (res) => {
            let {
              status,
              message,
              data
            } = res
            // 添加表格id
            for (let i = 0; i < data.length; i++) {
              data[i].newId = i + 1;
            }
            if (status !== 0) return alert("获取提交预览区信息失败！");
            const dataStr_preview = template('getPreview', {
              data: data
            });
            const dataStr_sub = template('getSubmitPreview', {
              data: data
            })
            $('#preview_tbody').html(dataStr_preview);
            $('#sub_tbody').html(dataStr_sub)
              // 调用对比函数
            compareArguments('length');
            compareArguments('seedRotation');
            compareArguments('cruRotation');
            compareArguments('mainHeater');
            compareArguments('slSpeed');
            compareArguments('meltLevel');
            compareArguments('argonFlow');
            compareArguments('controlTime');
            compareArguments('controlRate');
          }
        })
      }

      // 提交参数
      $('#sub_submit').on('click', function() {
        console.log($('#select_discription').val());
        var data = {
            0: [],
            1: [],
            2: [],
            3: [],
            4: [],
            5: [],
            6: [],
            7: [],
            8: [],
            9: [],
            10: [],
            11: []
          }
          // 片区、合同、描述、长度
        $('.length').each(function(index, element) {
            data[`${index}`].push($('#select_zoom').val())
            data[`${index}`].push($('#select_contract').val())
            data[`${index}`].push($('#select_discription').val())
            data[`${index}`].push($(this).html())
          })
          // 晶转
        $('.seedRotation').each(function(index, element) {
          data[`${index}`].push($(this).html())
        })
        $('.cruRotation').each(function(index, element) {
          data[`${index}`].push($(this).html())
        })
        $('.mainHeater').each(function(index, element) {
          data[`${index}`].push($(this).html())
        })
        $('.slSpeed').each(function(index, element) {
          data[`${index}`].push($(this).html())
        })
        $('.meltLevel').each(function(index, element) {
          data[`${index}`].push($(this).html())
        })
        $('.argonFlow').each(function(index, element) {
          data[`${index}`].push($(this).html())
        })
        $('.controlTime').each(function(index, element) {
          data[`${index}`].push($(this).html())
        })
        $('.controlRate').each(function(index, element) {
          data[`${index}`].push($(this).html())
        })
        $.ajax({
          type: 'POST',
          url: '/tech/arguments/postArguments',
          headers: {
            Authorization: localStorage.getItem('token') || ''
          },
          data: data,
          success: function(res) {
            console.log(res);
          }
        })
      })

      // 对比提交区和预览区参数函数
      function compareArguments(str) {
        let ele = `.${str}`;
        let compare_ele = `.compare_${str}`;
        let ele_data = `data-newId`;
        $(ele).blur(function() {
          let id = $(this).attr(ele_data);
          let value = $(this).html();
          let $length = $(this);
          $(compare_ele).each(function() {
            let compare_id = $(this).attr(ele_data);
            let compare_value = $(this).html();
            if (id == compare_id && value != compare_value) {
              $(this).css('backgroundColor', 'red')
              $length.css('backgroundColor', 'green')
            } else if (id == compare_id && value == compare_value) {
              $(this).css('backgroundColor', '')
              $length.css('backgroundColor', '')
            }
          })
        })
      }

      // 历史提交区渲染
      function getHistorySubmit(zoomMessage) {
        $.ajax({
          type: 'POST',
          url: '/tech/arguments/getHistorySubmit',
          headers: {
            Authorization: localStorage.getItem('token') || ''
          },
          data: zoomMessage,
          success: function(res) {
            let {
              status,
              message,
              data
            } = res;
            if (status != 0) return alert(message);
            data.map((element, index) => {
              element.newId = index + 1;
            });
            const dataStr_history = template('getHistorySubmit', {
              data: data
            });
            $('#submitHistory_tbody').html(dataStr_history);
          }
        })
      }

      // next
    })
  </script>
</body>

</html>